<div
  #wrapper
  class="wrapper"
  [class.visible]="!!worklog"
  (mousedown)="handleClickOutsideEditor($event)"
  [class.dragging]="dragging"
  [class.stretching]="stretching"
>
  <div
    class="panel-wrapper"
    [style.left.%]="panelOffsetLeft * 100"
    [style.top.px]="panelOffsetTop"
    [style.width.%]="panelWidth * 100"
    [style.height.px]="panelHeight"
    [class.visible]="editedPanelInRange"
    [class.buttons-outside-container]="panelHeight < 200"
    [class.tight-under]="spaceUnderPanel < 40"
    title="Hold:
Alt to snap to 1 minute,
nothing to snap to 5 minutes,
Shift to snap to 15 minutes,
Ctrl to snap to 60 minutes."
  >
    <div
      #panel
      class="panel"
      [style.border-color]="'hsl(' + panelHue + ', ' + panelSaturation + '%, 50%)'"
      (mousedown)="dragStart($event)"
    >
      <label>Issue</label>
      
      <!-- Owner/Assignee selector -->
      <div class="owner-selector">
        <div class="input-container">
          <input
            #ownerInput
            id="owner-input"
            class="tangible search"
            readonly
            [value]="selectedOwnerDisplay"
            placeholder="Your tasks (click to change user)"
            [disabled]="saving"
            (mousedown)="toggleUserPicker($event)"
            (keydown)="onOwnerInputKeydown($event)"
            [class.cloud-open]="userPickerOpen"
            [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
            title="Click to select a different user or leave empty to see your own tasks. Press Delete or Backspace to clear selection."
          >
          <button
            *ngIf="selectedOwnerDisplay"
            class="clear-user-button"
            type="button"
            (mousedown)="$event.stopPropagation()"
            (click)="$event.stopPropagation(); selectUser(null)"
            [disabled]="saving"
            title="Clear user selection"
          >
            ✖️
          </button>
        </div>
      </div>
      
      <input
        #issuePickerToggle
        id="issue-picker-toggle"
        readonly
        [disabled]="worklog?.id || saving"
        [value]="issueString"
        title=""
        class="tangible search"
        (mousedown)="toggleIssuePicker()"
        [class.cloud-open]="issuePickerOpen"
        [tabIndex]="shouldTabIndexBe0() && !worklog?.id ? 0 : -1"
      >
      <!-- Icono de precaución si la tarea no tiene estimación -->
      <span *ngIf="missingEstimate" class="warning-icon" title="Esta tarea no tiene estimación">⚠️</span>
      <span *ngIf="missingEstimate" class="warning-text">{{ warningMessage }}</span>
      <!-- Campo para ingresar estimación original -->
      <div *ngIf="missingEstimate" class="original-estimate-entry">
        <input
          type="text"
          class="tangible"
          [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
          placeholder="e.g. 1h 30m"
          [(ngModel)]="originalEstimateText"
        />
        <button
          class="button small tangible"
          [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
          (click)="setOriginalEstimate()"
          [disabled]="!originalEstimateText"
        >Set estimate</button>
      </div>
      <label for="date-picker-toggle">Date</label>
      <input
        #calendarToggle
        id="date-picker-toggle"
        class="tangible"
        [class.cloud-open]="calendarOpen"
        title=""
        (mousedown)="toggleCalendar()"
        [disabled]="saving"
        [value]="dateString"
        readonly
        [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
      >
      <label for="comment-textarea">Comment</label>
      <textarea
        #commentTextArea
        id="comment-textarea"
        [(ngModel)]="commentString"
        title=""
        class="tangible space-under"
        [disabled]="saving"
        [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
      ></textarea>
    </div>

    <div class="buttons-area">
      <button
        id="save-button"
        class="button primary tangible"
        [disabled]="saving || !worklog || !worklog.issueId"
        title=""
        (click)="save()"
        [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
      >
        <span *ngIf="saving" class="spinner"></span>
        <ng-container *ngIf="!saving">{{ this.adding ? 'Add' : 'Save' }}</ng-container>
      </button>
      <button
        #cancelButton
        class="button tangible"
        [class.non-translucent]="panelHeight < 200"
        (click)="close()"
        [disabled]="saving"
        title=""
        [tabIndex]="shouldTabIndexBe0() ? 0 : -1"
      >Cancel</button>
    </div>

    <div
      class="handle-top"
      [style.border-color]="'hsl(' + panelHue + ', ' + panelSaturation + '%, 50%)'"
      (mousedown)="stretchTopStart($event)"
    ></div>
    <div
      class="handle-bottom"
      [style.border-color]="'hsl(' + panelHue + ', ' + panelSaturation + '%, 50%)'"
      (mousedown)="stretchBottomStart($event)"
    ></div>

    <div class="start-time">{{ startTimeString }}</div>
    <div class="end-time">{{ endTimeString }}</div>

    <plaid-date-picker-cloud
      [(open)]="calendarOpen"
      [style.top.px]="calendarOffsetTop"
      [flipped]="flipCalendar"
      [selectedDate]="date"
      (selectedDateChange)="selectDate($event)"
      title=""
      [selectableDaysStart]="visibleDaysStart"
      [selectableDaysEnd]="visibleDaysEnd"
      [keysDisabled]="keysDisabled"
    ></plaid-date-picker-cloud>

    <plaid-issue-picker-cloud
      [(open)]="issuePickerOpen"
      [style.top.px]="issuePickerOffsetTop"
      (issueChange)="selectIssue($event)"
      [updateFavoritesAndSuggestionsAndEmitSuggestion]="updateFavoriteIssuesAndSuggestionsAndEmitSuggestion.asObservable()"
      [assignee]="selectedOwner"
      title=""
      [keysDisabled]="keysDisabled"
    ></plaid-issue-picker-cloud>

    <plaid-user-picker-cloud
      [(open)]="userPickerOpen"
      [style.top.px]="userPickerOffsetTop"
      (userChange)="selectUser($event)"
      title=""
      [keysDisabled]="keysDisabled"
    ></plaid-user-picker-cloud>
  </div>

  <a
    class="button non-translucent"
    id="return-button"
    [class.visible]="!editedPanelInRange"
    (click)="returnToEditedWorklog()"
  >Return to edited worklog</a>
</div>
